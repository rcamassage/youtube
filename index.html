<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube ì˜ìƒ ê²€ìƒ‰ ëŒ€ì‹œë³´ë“œ</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© ë° ë°°ê²½ìƒ‰ ì„¤ì • */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
            min-height: 100vh;
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        /* ì˜ìƒ ê¸¸ì´ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
        .duration-overlay {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- API Key ì…ë ¥ ëª¨ë‹¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€) -->
    <div id="apiKeyModal" class="modal-overlay hidden">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md mx-4 transform transition duration-300">
            <h2 class="text-xl font-bold text-gray-800 mb-4">YouTube API í‚¤ ì…ë ¥</h2>
            <p class="text-gray-600 mb-4 text-sm">
                ì˜ìƒì„ ê²€ìƒ‰í•˜ë ¤ë©´ YouTube Data API v3 í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì´ í‚¤ëŠ” Firestoreì— ì•ˆì „í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤.
            </p>
            <input
                type="text"
                id="apiKeyInput"
                placeholder="ì—¬ê¸°ì— API í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"
                class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
            <div id="modalMessage" class="text-sm text-red-500 mb-4 font-medium hidden"></div>
            <div class="flex justify-end gap-3">
                <button
                    id="saveApiKeyButton"
                    class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-150 active:scale-95"
                >
                    í‚¤ ì €ì¥ ë° ì‚¬ìš©
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <!-- í—¤ë” ë° íƒ€ì´í‹€ -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">
                YouTube ì˜ìƒ ê²€ìƒ‰ ëŒ€ì‹œë³´ë“œ
            </h1>
            <p class="text-gray-500">í‚¤ì›Œë“œ ë° ê³ ê¸‰ í•„í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ YouTube ì˜ìƒì„ ê²€ìƒ‰í•˜ê³  ìƒì„¸ í†µê³„ë¥¼ ë¶„ì„í•˜ì„¸ìš”.</p>
        </header>

        <!-- ê²€ìƒ‰ ë° í•„í„° ì„¹ì…˜ -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <div id="loadingIndicator" class="text-center hidden mb-4">
                <div class="spinner mr-2"></div>
                <span class="text-blue-500 font-semibold">ê²€ìƒ‰ ë° ë°ì´í„° ë¶„ì„ ì¤‘... (API 2ë‹¨ê³„ ìš”ì²­)</span>
            </div>

            <p id="messageBox" class="text-sm mt-3 text-red-500 font-medium"></p>
            
            <!-- 1. í‚¤ì›Œë“œ ë° ì‹¤í–‰ ë²„íŠ¼ -->
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <input
                    type="text"
                    id="searchKeyword"
                    placeholder="ê²€ìƒ‰í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì œë¯¸ë‚˜ì´ ì½”ë”©)"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150"
                    required
                >
                <button
                    id="searchButton"
                    class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-150 active:scale-95 disabled:bg-gray-400"
                >
                    ê²€ìƒ‰ ì‹œì‘
                </button>
                <button
                    id="openModalButton"
                    class="bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-gray-500 transition duration-150 active:scale-95"
                    title="API í‚¤ ë‹¤ì‹œ ì…ë ¥"
                >
                    ğŸ”‘ í‚¤ ë³€ê²½
                </button>
            </div>

            <!-- 2. ê³ ê¸‰ í•„í„° ì˜µì…˜ -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 text-sm">
                
                <!-- ì •ë ¬ ë°©ì‹ -->
                <div>
                    <label for="sortBy" class="block text-gray-700 font-medium mb-1">ì •ë ¬ ê¸°ì¤€</label>
                    <select id="sortBy" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="relevance">ê´€ë ¨ì„± (ê¸°ë³¸)</option>
                        <option value="viewCount">ì¡°íšŒìˆ˜</option>
                        <option value="date">ì—…ë¡œë“œ ë‚ ì§œ</option>
                    </select>
                </div>

                <!-- ê²°ê³¼ ìˆ˜ëŸ‰ -->
                <div>
                    <label for="maxResults" class="block text-gray-700 font-medium mb-1">ê²°ê³¼ ìˆ˜</label>
                    <select id="maxResults" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="30">30ê°œ</option>
                        <option value="50" selected>50ê°œ</option>
                        <option value="100">100ê°œ</option>
                        <option value="200">200ê°œ (ì£¼ì˜: API í• ë‹¹ëŸ‰ ì†Œëª¨)</option>
                    </select>
                </div>

                <!-- ì˜ìƒ ê¸¸ì´ -->
                <div>
                    <label for="videoDuration" class="block text-gray-700 font-medium mb-1">ì˜ìƒ ê¸¸ì´</label>
                    <select id="videoDuration" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="any">ì „ì²´ (ê¸°ë³¸)</option>
                        <option value="short">ìˆì¸  (4ë¶„ ë¯¸ë§Œ)</option>
                        <option value="medium">4ë¶„ ~ 20ë¶„</option>
                        <option value="long">20ë¶„ ì´ìƒ</option>
                    </select>
                </div>

                <!-- ê¸°ê°„ -->
                <div>
                    <label for="dateRange" class="block text-gray-700 font-medium mb-1">ê¸°ê°„</label>
                    <select id="dateRange" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="all">ì „ì²´ (ê¸°ë³¸)</option>
                        <option value="today">ì˜¤ëŠ˜</option>
                        <option value="thisWeek">ì´ë²ˆ ì£¼</option>
                        <option value="thisMonth">ì´ë²ˆ ë‹¬</option>
                        <option value="thisYear">ì´ë²ˆ ë…„</option>
                    </select>
                </div>

                <!-- ìµœì†Œ ì¡°íšŒìˆ˜ (í´ë¼ì´ì–¸íŠ¸ í•„í„°) -->
                <div>
                    <label for="minViews" class="block text-gray-700 font-medium mb-1">ìµœì†Œ ì¡°íšŒìˆ˜</label>
                    <input type="number" id="minViews" placeholder="0" value="0" min="0" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                
                <!-- êµ­ê°€ (ë¦¬ì „) -->
                <div>
                    <label for="regionCode" class="block text-gray-700 font-medium mb-1">êµ­ê°€</label>
                    <select id="regionCode" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="">ì „ì²´ (ê¸°ë³¸)</option>
                        <option value="KR">ëŒ€í•œë¯¼êµ­</option>
                        <option value="US">ë¯¸êµ­</option>
                        <option value="JP">ì¼ë³¸</option>
                        <option value="CN">ì¤‘êµ­</option>
                        <option value="TH">íƒœêµ­</option>
                    </select>
                </div>

                <!-- íƒœê·¸ í¬í•¨/ë¶ˆí¬í•¨ ì˜µì…˜ -->
                <div class="col-span-2 md:col-span-4 lg:col-span-6">
                    <label class="inline-flex items-center mt-3">
                        <input type="checkbox" id="tagInclusion" checked class="form-checkbox h-4 w-4 text-blue-600 rounded">
                        <span class="ml-2 text-gray-700 font-medium">ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì˜ìƒ íƒœê·¸ì— í¬í•¨í•˜ì—¬ ê²€ìƒ‰</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ -->
        <div id="searchResultsContainer" class="hidden">
            <h2 id="resultCountHeader" class="text-xl font-bold text-gray-800 mb-4">ê²€ìƒ‰ ê²°ê³¼ (0ê°œ)</h2>
            <div id="resultsList" class="space-y-4">
                <!-- ì—¬ê¸°ì— ê²€ìƒ‰ ê²°ê³¼ ì¹´ë“œê°€ ì‚½ì…ë©ë‹ˆë‹¤. -->
            </div>
        </div>
    </div>

    <!-- JavaScript ë¡œì§ (type="module"ë¡œ ë³€ê²½í•˜ì—¬ Firebase Import ê°€ëŠ¥) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestore ë¡œê¹… í™œì„±í™” (ë””ë²„ê¹… ëª©ì )
        setLogLevel('debug');

        // GitHub/ì™¸ë¶€ í™˜ê²½ì—ì„œ Firebaseë¥¼ ì´ˆê¸°í™”í•˜ê¸° ìœ„í•œ ë”ë¯¸ ì„¤ì • ë˜ëŠ” ì‚¬ìš©ì ì…ë ¥ ì„¤ì •
        const dummyFirebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY", // ì‹¤ì œ í‚¤ë¡œ ëŒ€ì²´í•´ì•¼ í•©ë‹ˆë‹¤.
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };


        // Global variables provided by the Canvas environment (with fallback for external hosting)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // __firebase_configê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ê±°ë‚˜ íŒŒì‹±ì— ì‹¤íŒ¨í•˜ë©´ dummyFirebaseConfigë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const firebaseConfig = (() => {
            try {
                return typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : dummyFirebaseConfig;
            } catch (e) {
                console.warn("Failed to parse __firebase_config. Using dummy configuration.", e);
                return dummyFirebaseConfig;
            }
        })();
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'anonymous'; 
        
        // NOTE: The user has requested to hardcode this key for testing purposes to bypass immediate API key input errors.
        const DEFAULT_YOUTUBE_API_KEY = 'AIzaSyDe0emcV4KC675d04fgKn1bmFPdXldpdxE';
        let youtubeApiKey = DEFAULT_YOUTUBE_API_KEY; // Pre-fill with the user-provided key

        // DOM ìš”ì†Œ ìºì‹œ
        const searchKeywordInput = document.getElementById('searchKeyword');
        const searchButton = document.getElementById('searchButton');
        const openModalButton = document.getElementById('openModalButton');
        const messageBox = document.getElementById('messageBox');
        const loadingIndicator = document.getElementById('loadingIndicator');

        const apiKeyModal = document.getElementById('apiKeyModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyButton = document.getElementById('saveApiKeyButton');
        const modalMessage = document.getElementById('modalMessage');

        const resultsList = document.getElementById('resultsList');
        const searchResultsContainer = document.getElementById('searchResultsContainer');
        const resultCountHeader = document.getElementById('resultCountHeader');
        
        // í•„í„° ìš”ì†Œ ìºì‹œ
        const sortBySelect = document.getElementById('sortBy');
        const maxResultsSelect = document.getElementById('maxResults');
        const videoDurationSelect = document.getElementById('videoDuration');
        const dateRangeSelect = document.getElementById('dateRange');
        const minViewsInput = document.getElementById('minViews');
        const regionCodeSelect = document.getElementById('regionCode');
        const tagInclusionCheckbox = document.getElementById('tagInclusion');

        // =================================================================
        // Firebase ë° API Key ê´€ë¦¬ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
        // =================================================================
        
        async function initializeFirebase() {
            // ì™¸ë¶€ í˜¸ìŠ¤íŒ… ì‹œ, dummyFirebaseConfigì— ì‹¤ì œ ê°’ì´ ì…ë ¥ë˜ì§€ ì•Šìœ¼ë©´ Firestore ê¸°ëŠ¥ ì‚¬ìš© ë¶ˆê°€ ê²½ê³ 
            if (firebaseConfig === dummyFirebaseConfig && firebaseConfig.apiKey === "YOUR_FIREBASE_API_KEY") {
                console.warn("ğŸš¨ Firebase ì„¤ì •ì´ ê¸°ë³¸ê°’ì…ë‹ˆë‹¤. í‚¤ ì €ì¥ ê¸°ëŠ¥ì€ Canvas ì™¸ë¶€ì—ì„œ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                messageBox.textContent = "Firebase ì„¤ì •ì´ ê¸°ë³¸ê°’ì…ë‹ˆë‹¤. API í‚¤ ì €ì¥ì„ ìœ„í•´ì„œëŠ” Firebase ì„¤ì •ì„ ì§ì ‘ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.";
                
                // Canvas ì™¸ë¶€ì—ì„œëŠ” ì¸ì¦ì´ ì„±ê³µí•˜ì§€ ëª»í•˜ë¯€ë¡œ ìµëª…ìœ¼ë¡œ ê°•ì œ ì„¤ì •
                userId = crypto.randomUUID(); // ê³ ìœ  IDë¡œ ì„¤ì •í•˜ì—¬ í‚¤ ì €ì¥ì†Œ ê²½ë¡œë§Œ ìƒì„±
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // initialAuthTokenì´ ìˆì„ ë•Œë§Œ Custom Token ì¸ì¦ ì‹œë„ (Canvas í™˜ê²½)
                // ì—†ì„ ê²½ìš° ìµëª… ì¸ì¦ ì‹œë„ (ì™¸ë¶€ í™˜ê²½, í˜¹ì€ ì¸ì¦ í† í° ì—†ëŠ” ê²½ìš°)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                if (auth.currentUser) {
                    userId = auth.currentUser.uid;
                    console.log("Firebase initialized and user signed in. UID:", userId);
                    await loadApiKey();
                } else {
                    // ìµëª… ì¸ì¦ë„ ì‹¤íŒ¨í•˜ë©´ userIdë¥¼ ì„ì‹œ ê³ ìœ  IDë¡œ ìœ ì§€
                    console.warn("Firebase initialized, but no user is signed in. Using temporary UUID for storage context.");
                }
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                // Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œ ë©”ì‹œì§€ ë°•ìŠ¤ì— ì¶œë ¥
                messageBox.textContent = "Firebase ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í‚¤ ì €ì¥ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.";
            }
        }
        
        async function loadApiKey() {
            if (!db || !userId) return;
            const keyDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings/youtube_api_key`);
            try {
                const docSnap = await getDoc(keyDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    youtubeApiKey = data.key; // Load from Firestore if exists
                    console.log("API Key loaded successfully from Firestore.");
                } else {
                    console.log("No stored API Key found. Using default hardcoded key.");
                    // youtubeApiKeyëŠ” ì´ë¯¸ DEFAULT_YOUTUBE_API_KEYë¡œ ì„¤ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë³„ë„ ì„¤ì • ë¶ˆí•„ìš”
                    showApiKeyModal(true); // í‚¤ ì…ë ¥ ì°½ì€ ë„ì›Œì„œ í™•ì¸í•˜ë„ë¡ ìœ ë„
                }
            } catch (e) {
                console.error("Error loading API key:", e);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ëª¨ë‹¬ì„ ë„ì›Œ ì‚¬ìš©ìì—ê²Œ í‚¤ ì…ë ¥ ìœ ë„
                showApiKeyModal(true); 
            }
        }

        async function saveApiKey(key) {
            if (!db || !userId || !key) {
                modalMessage.textContent = "ì €ì¥ ì˜¤ë¥˜: ë°ì´í„°ë² ì´ìŠ¤ ë˜ëŠ” ì‚¬ìš©ì IDê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                modalMessage.classList.remove('hidden');
                return;
            }

            const keyDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings/youtube_api_key`);
            
            try {
                await setDoc(keyDocRef, { key: key, savedAt: new Date().toISOString() });
                youtubeApiKey = key;
                apiKeyModal.classList.add('hidden');
                modalMessage.classList.add('hidden');
                messageBox.textContent = "âœ… API í‚¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
                console.log("API Key saved successfully to Firestore.");
            } catch (e) {
                console.error("Error saving API key:", e);
                modalMessage.textContent = `í‚¤ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}. Firebase ì„¤ì •ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.`;
                modalMessage.classList.remove('hidden');
            }
        }
        
        function showApiKeyModal(show) {
            if (show) {
                // í˜„ì¬ youtubeApiKey ê°’ì„ ì…ë ¥ í•„ë“œì— ìë™ ì±„ì›€ (ê¸°ë³¸ê°’ ë˜ëŠ” Firestoreì—ì„œ ë¡œë“œëœ ê°’)
                if (youtubeApiKey !== '') {
                    apiKeyInput.value = youtubeApiKey;
                }
                apiKeyModal.classList.remove('hidden');
                apiKeyInput.focus();
            } else {
                apiKeyModal.classList.add('hidden');
            }
        }

        // =================================================================
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        // =================================================================

        /**
         * ìˆ«ìë¥¼ ì²œ ë‹¨ìœ„ êµ¬ë¶„ ê¸°í˜¸ê°€ ìˆëŠ” ë¬¸ìì—´ë¡œ í¬ë§·í•©ë‹ˆë‹¤.
         */
        function formatNumber(num) {
            if (num === undefined || num === null) return 'N/A';
            const numberValue = Number(num) || 0; 
            return numberValue.toLocaleString('ko-KR');
        }

        /**
         * ISO 8601 Duration ë¬¸ìì—´ì„ ì‹œê³„ì—´ í¬ë§· (HH:MM:SS)ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
         * ì˜ˆ: PT1H30M15S -> 1:30:15
         */
        function formatDuration(iso8601) {
            if (!iso8601) return 'N/A';
            const match = iso8601.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            if (!match) return 'N/A';

            const hours = parseInt(match[1]) || 0;
            const minutes = parseInt(match[2]) || 0;
            const seconds = parseInt(match[3]) || 0;

            const pad = (num) => String(num).padStart(2, '0');

            if (hours > 0) {
                return `${hours}:${pad(minutes)}:${pad(seconds)}`;
            } else {
                return `${minutes}:${pad(seconds)}`;
            }
        }

        /**
         * ì„ íƒëœ ê¸°ê°„ì— ë”°ë¼ ISO 8601 í˜•ì‹ì˜ 'publishedAfter' ë‚ ì§œë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
         * @returns {string | undefined} ISO 8601 ë‚ ì§œ ë˜ëŠ” undefined
         */
        function calculatePublishedAfter(range) {
            const now = new Date();
            let date = new Date(now);

            switch (range) {
                case 'today':
                    date.setHours(0, 0, 0, 0); // ì˜¤ëŠ˜ 0ì‹œ
                    break;
                case 'thisWeek':
                    date.setDate(now.getDate() - now.getDay()); // ì´ë²ˆ ì£¼ ì¼ìš”ì¼ (ì‹œì‘ì¼)
                    date.setHours(0, 0, 0, 0);
                    break;
                case 'thisMonth':
                    date.setDate(1); // ì´ë²ˆ ë‹¬ 1ì¼
                    date.setHours(0, 0, 0, 0);
                    break;
                case 'thisYear':
                    date.setMonth(0, 1); // ì´ë²ˆ ë…„ë„ 1ì›” 1ì¼
                    date.setHours(0, 0, 0, 0);
                    break;
                default:
                    return undefined;
            }
            return date.toISOString().split('.')[0] + 'Z'; // ISO 8601 í¬ë§·
        }

        /**
         * UI ìƒíƒœë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
         * @param {boolean} isLoading
         */
        function setUIState(isLoading) {
            searchButton.disabled = isLoading;
            openModalButton.disabled = isLoading;
            loadingIndicator.classList.toggle('hidden', !isLoading);
        }

        // =================================================================
        // í´ë¦½ë³´ë“œ ë³µì‚¬ ë¡œì§
        // =================================================================

        /**
         * íƒœê·¸ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í•˜ê³  í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤.
         * @param {string} tagsString - ë³µì‚¬í•  ì‰¼í‘œë¡œ êµ¬ë¶„ëœ íƒœê·¸ ë¬¸ìì—´
         * @param {HTMLElement} buttonElement - ë²„íŠ¼ ìš”ì†Œ
         */
        function copyTagsToClipboard(tagsString, buttonElement) {
            const tempInput = document.createElement('textarea');
            tempInput.value = tagsString;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            let success = false;
            try {
                // document.execCommand('copy')ëŠ” iframe í™˜ê²½ì—ì„œ ë³µì‚¬ì— ê°€ì¥ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì…ë‹ˆë‹¤.
                success = document.execCommand('copy');
            } catch (err) {
                console.error('Clipboard copy failed:', err);
            }
            
            document.body.removeChild(tempInput);

            // í”¼ë“œë°± ì œê³µ
            const originalText = buttonElement.textContent;
            const originalClasses = buttonElement.className;

            if (success) {
                buttonElement.textContent = 'âœ… ë³µì‚¬ ì™„ë£Œ!';
                buttonElement.className = originalClasses.replace('bg-green-500', 'bg-lime-600').replace('bg-red-600', 'bg-lime-600');
            } else {
                buttonElement.textContent = 'âŒ ë³µì‚¬ ì‹¤íŒ¨!';
                buttonElement.className = originalClasses.replace('bg-green-500', 'bg-red-600').replace('bg-lime-600', 'bg-red-600');
            }

            // 2ì´ˆ í›„ ì›ë˜ëŒ€ë¡œ ë³µêµ¬
            setTimeout(() => {
                buttonElement.textContent = originalText;
                buttonElement.className = originalClasses;
            }, 2000);
        }


        // =================================================================
        // ê²€ìƒ‰ ë° ë¶„ì„ ë¡œì§ (2ë‹¨ê³„ ìš”ì²­)
        // =================================================================

        /**
         * YouTube ê²€ìƒ‰ API (Step 1)ë¥¼ í˜¸ì¶œí•˜ê³ , ê·¸ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ Videos API (Step 2)ë¥¼ í˜¸ì¶œí•˜ì—¬ ìµœì¢… ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
         */
        async function runSearchAndAnalysis() {
            // youtubeApiKeyê°€ ê¸°ë³¸ê°’(í•˜ë“œì½”ë”©ëœ í‚¤)ì´ê±°ë‚˜ Firestoreì—ì„œ ë¡œë“œëœ ìœ íš¨í•œ í‚¤ì—¬ì•¼ ê²€ìƒ‰ ì‹¤í–‰
            if (!youtubeApiKey || youtubeApiKey.length < 20) {
                messageBox.textContent = "ğŸš¨ YouTube API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•˜ê³  ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.";
                showApiKeyModal(true);
                return;
            }

            setUIState(true);
            messageBox.textContent = '';
            resultsList.innerHTML = '';
            searchResultsContainer.classList.add('hidden');

            const keyword = searchKeywordInput.value.trim();
            const sortBy = sortBySelect.value;
            const maxResults = maxResultsSelect.value;
            const videoDuration = videoDurationSelect.value;
            const dateRange = dateRangeSelect.value;
            const regionCode = regionCodeSelect.value;
            const minViews = parseInt(minViewsInput.value) || 0;

            if (!keyword) {
                messageBox.textContent = "ğŸš¨ ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
                setUIState(false);
                return;
            }

            try {
                // --- Step 1: Search API í˜¸ì¶œ (ì˜ìƒ ID ëª©ë¡ ë° ê¸°ë³¸ ë©”íƒ€ë°ì´í„° ê°€ì ¸ì˜¤ê¸°) ---
                let searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(keyword)}&type=video&maxResults=${maxResults}&order=${sortBy}&key=${youtubeApiKey}`;
                
                // Duration í•„í„° (APIì—ì„œ ê°€ëŠ¥í•œ ê²½ìš°ë§Œ ì ìš©)
                if (videoDuration !== 'any') {
                    searchUrl += `&videoDuration=${videoDuration}`;
                }

                // Period í•„í„° (publishedAfter ê³„ì‚°)
                const publishedAfter = calculatePublishedAfter(dateRange);
                if (publishedAfter) {
                    searchUrl += `&publishedAfter=${publishedAfter}`;
                }

                // Region í•„í„°
                if (regionCode) {
                    searchUrl += `&regionCode=${regionCode}`;
                }

                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();

                if (searchData.error) {
                    messageBox.textContent = `Search API ì˜¤ë¥˜: ${searchData.error.message}`;
                    setUIState(false);
                    return;
                }

                if (searchData.items.length === 0) {
                    messageBox.textContent = `âš ï¸ í‚¤ì›Œë“œ "${keyword}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`;
                    setUIState(false);
                    return;
                }

                const videoIds = searchData.items
                    .map(item => item.id.videoId)
                    .filter(id => id); // ìœ íš¨í•œ IDë§Œ ì¶”ì¶œ

                if (videoIds.length === 0) {
                     messageBox.textContent = `âš ï¸ í‚¤ì›Œë“œ "${keyword}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`;
                    setUIState(false);
                    return;
                }

                // --- Step 2: Videos API í˜¸ì¶œ (ì¡°íšŒìˆ˜, ê¸¸ì´, ìƒì„¸ íƒœê·¸ ê°€ì ¸ì˜¤ê¸°) ---
                const videoIdsString = videoIds.join(',');
                const videosUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${videoIdsString}&key=${youtubeApiKey}`;

                const videosResponse = await fetch(videosUrl);
                const videosData = await videosResponse.json();

                if (videosData.error) {
                    messageBox.textContent = `Videos API ì˜¤ë¥˜: ${videosData.error.message}`;
                    setUIState(false);
                    return;
                }

                // --- Step 3: ë°ì´í„° í†µí•© ë° í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§ ---
                let finalResults = videosData.items.map(video => {
                    const snippet = video.snippet || {};
                    const statistics = video.statistics || {};
                    const contentDetails = video.contentDetails || {};

                    return {
                        id: video.id,
                        title: snippet.title,
                        publishedAt: snippet.publishedAt,
                        channelTitle: snippet.channelTitle,
                        description: snippet.description,
                        tags: snippet.tags || [],
                        thumbnailUrl: snippet.thumbnails?.medium?.url || '',
                        viewCount: parseInt(statistics.viewCount) || 0,
                        duration: formatDuration(contentDetails.duration)
                    };
                });
                
                // ìµœì†Œ ì¡°íšŒìˆ˜ í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§ ì ìš©
                const filteredResults = finalResults.filter(video => video.viewCount >= minViews);
                
                // --- Step 4: ê²°ê³¼ ë Œë”ë§ ---
                renderResults(filteredResults, keyword);

            } catch (error) {
                console.error("Search/Analysis Error:", error);
                messageBox.textContent = "ğŸ˜­ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.";
            } finally {
                setUIState(false);
            }
        }


        /**
         * ê²€ìƒ‰ ê²°ê³¼ë¥¼ HTML ë¦¬ìŠ¤íŠ¸ë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
         * @param {Array<Object>} videos - í•„í„°ë§ëœ ì˜ìƒ ë°ì´í„° ë°°ì—´
         * @param {string} keyword - ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê²€ìƒ‰ í‚¤ì›Œë“œ
         */
        function renderResults(videos, keyword) {
            resultsList.innerHTML = ''; // ê¸°ì¡´ ê²°ê³¼ ì§€ìš°ê¸°
            searchResultsContainer.classList.remove('hidden');
            resultCountHeader.textContent = `ê²€ìƒ‰ ê²°ê³¼ (${formatNumber(videos.length)}ê°œ)`;

            if (videos.length === 0) {
                resultsList.innerHTML = '<p class="text-gray-500 p-4 bg-white rounded-lg shadow-md">ì ìš©ëœ í•„í„° ì¡°ê±´ì— ë§ëŠ” ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const searchTerms = keyword.toLowerCase().split(/\s+/).filter(t => t.length > 0);

            videos.forEach(video => {
                const videoLink = `https://www.youtube.com/watch?v=${video.id}`;
                const publishedDate = new Date(video.publishedAt).toLocaleDateString('ko-KR');
                const rawTagsString = video.tags.join(', '); // ë³µì‚¬ìš© ì‰¼í‘œ êµ¬ë¶„ ë¬¸ìì—´

                // 1. íƒœê·¸ ëª©ë¡ ìƒì„± ë° ìˆœìœ„ ê³„ì‚° (CRITICAL)
                let tagsHtml = video.tags.map((tag, index) => {
                    const tagLower = tag.toLowerCase();
                    let rankBadge = '';
                    
                    // ê²€ìƒ‰ í‚¤ì›Œë“œì— í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
                    for (const term of searchTerms) {
                        if (tagLower.includes(term)) {
                            // 1ë¶€í„° ì‹œì‘í•˜ëŠ” ìˆœìœ„ í‘œì‹œ
                            rankBadge = `<span class="text-xs ml-1 font-bold text-red-600 bg-red-100 px-2 py-0.5 rounded-full inline-block">(ìˆœìœ„: ${index + 1})</span>`;
                            break; // ì²« ë²ˆì§¸ ì¼ì¹˜í•˜ëŠ” í‚¤ì›Œë“œë§Œ ìˆœìœ„ í‘œì‹œ
                        }
                    }
                    return `<span class="bg-gray-200 text-gray-700 text-xs font-medium px-2 py-1 rounded-md inline-block mr-2 mb-1">${tag}</span>${rankBadge}`;
                }).join('');

                const copyButtonHtml = video.tags.length > 0 ? `
                    <button 
                        class="copy-tags-btn bg-green-500 text-white text-xs font-semibold px-2 py-1 rounded hover:bg-green-600 transition duration-150 active:scale-95"
                        data-tags="${rawTagsString.replace(/"/g, '&quot;')}" 
                        title="ëª¨ë“  íƒœê·¸ë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ë³µì‚¬í•©ë‹ˆë‹¤."
                    >
                        ğŸ”— íƒœê·¸ ì „ì²´ ë³µì‚¬
                    </button>
                ` : '';

                const videoCard = `
                    <div class="bg-white p-4 rounded-xl shadow-lg flex flex-col md:flex-row gap-4 border-l-4 border-blue-500 hover:shadow-xl transition duration-200">
                        
                        <!-- ì¸ë„¤ì¼ ë° ê¸¸ì´ (ì¢Œì¸¡) -->
                        <div class="relative w-full md:w-56 flex-shrink-0">
                            <a href="${videoLink}" target="_blank" rel="noopener noreferrer">
                                <img src="${video.thumbnailUrl}" alt="${video.title}" class="w-full h-auto rounded-lg shadow-md object-cover">
                            </a>
                            <span class="duration-overlay">${video.duration}</span>
                        </div>

                        <!-- ë‚´ìš© (ìš°ì¸¡) -->
                        <div class="flex-grow">
                            <!-- ì œëª© -->
                            <h3 class="text-lg font-bold text-gray-900 mb-1 line-clamp-2">
                                <a href="${videoLink}" target="_blank" rel="noopener noreferrer" class="hover:text-blue-600 transition duration-150">${video.title}</a>
                            </h3>
                            
                            <!-- ì±„ë„ëª… ë° ë‚ ì§œ -->
                            <p class="text-sm text-blue-600 font-medium mb-2">${video.channelTitle} Â· ${publishedDate} ì—…ë¡œë“œ</p>

                            <!-- ì¡°íšŒìˆ˜ -->
                            <div class="text-md font-semibold text-green-600 mb-3">
                                ì¡°íšŒìˆ˜: ${formatNumber(video.viewCount)}íšŒ
                            </div>

                            <!-- íƒœê·¸ ëª©ë¡ ë° ë³µì‚¬ ë²„íŠ¼ -->
                            <div class="mt-2 pt-2 border-t border-gray-100">
                                <div class="flex items-center justify-between mb-1">
                                    <p class="text-xs font-semibold text-gray-500">íƒœê·¸ (${video.tags.length}ê°œ):</p>
                                    ${copyButtonHtml}
                                </div>
                                <div class="flex flex-wrap items-center">
                                    ${tagsHtml || '<span class="text-xs text-gray-400">íƒœê·¸ ì •ë³´ ì—†ìŒ</span>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                resultsList.insertAdjacentHTML('beforeend', videoCard);
            });
        }

        // =================================================================
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        // =================================================================

        // 1. ê²€ìƒ‰ ë²„íŠ¼
        searchButton.addEventListener('click', runSearchAndAnalysis);
        searchKeywordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                runSearchAndAnalysis();
            }
        });

        // 2. í‚¤ ë³€ê²½ ë²„íŠ¼ (API í‚¤ ëª¨ë‹¬ ì—´ê¸°)
        openModalButton.addEventListener('click', () => {
            if (youtubeApiKey) {
                apiKeyInput.value = youtubeApiKey;
            }
            showApiKeyModal(true);
        });

        // 3. ëª¨ë‹¬ ì €ì¥ ë²„íŠ¼
        saveApiKeyButton.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key.length < 20) { 
                modalMessage.textContent = "ìœ íš¨í•œ API í‚¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
                modalMessage.classList.remove('hidden');
                return;
            }
            saveApiKey(key);
        });

        // 4. íƒœê·¸ ë³µì‚¬ ë²„íŠ¼ (ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©)
        resultsList.addEventListener('click', (event) => {
            const button = event.target.closest('.copy-tags-btn');
            if (button) {
                const tagsString = button.dataset.tags;
                if (tagsString) {
                    copyTagsToClipboard(tagsString, button);
                }
            }
        });
        
        // 5. ì´ˆê¸°í™”
        window.addEventListener('load', initializeFirebase);
    </script>
</body>
</html>
